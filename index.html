<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mario World Ultimate</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background-color: #222; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            overflow: hidden;
            font-family: 'Arial Black', sans-serif;
        }

        #game-viewport { 
            width: 800px; 
            height: 450px; 
            position: relative; 
            overflow: hidden; 
            border: 4px solid #fff; 
            background: linear-gradient(#63c4eb, #ade1f5);
        }

        #world { 
            position: absolute; 
            width: 5000px; 
            height: 100%; 
        }

        .floor { 
            position: absolute; 
            bottom: 0; 
            width: 100%; 
            height: 60px; 
            background-color: #27ae60; 
            border-top: 6px solid #1e8449; 
        }

        /* --- OBJETOS DO MAPA --- */
        #goal-post { position: absolute; left: 4600px; bottom: 60px; width: 10px; height: 300px; background: #ddd; }
        #flag { position: absolute; left: 4610px; bottom: 310px; width: 50px; height: 40px; background: red; border: 2px solid white; transition: bottom 1s; }
        .block { position: absolute; width: 40px; height: 40px; background: #f39c12; border: 3px solid #e67e22; }

        /* --- MARIO --- */
        #mario { 
            position: absolute; 
            width: 100px; 
            height: 100px; 
            z-index: 10; 
            image-rendering: pixelated; 
            mix-blend-mode: multiply; 
        }

        /* --- TELAS DE INTERFACE --- */
        .overlay {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            text-align: center;
        }

        .overlay h1 { color: yellow; font-size: 50px; text-shadow: 4px 4px #000; margin-bottom: 20px; }
        .game-over h1 { color: #ff4d4d; }

        .btn-ui {
            padding: 15px 30px;
            font-size: 20px;
            background-color: #e74c3c;
            color: white;
            border: 4px solid #c0392b;
            cursor: pointer;
            text-transform: uppercase;
        }
    </style>
</head>
<body>

    <div id="game-viewport">
        <div id="win-screen" class="overlay">
            <h1>COURSE CLEAR!</h1>
            <button class="btn-ui" onclick="resetJogo()">JOGAR DE NOVO</button>
        </div>

        <div id="death-screen" class="overlay game-over">
            <h1>GAME OVER</h1>
            <button class="btn-ui" onclick="resetJogo()">TENTAR DE NOVO</button>
        </div>
        
        <div id="world">
            <div class="floor"></div>
            <div id="goal-post"></div>
            <div id="flag"></div>
            
            <div class="block" style="left: 500px; bottom: 150px;"></div>
            <div class="block" style="left: 1200px; bottom: 200px;"></div>
            <div class="block" style="left: 2500px; bottom: 150px;"></div>

            <img id="mario" src="parado_dir.png">
        </div>
    </div>

    <script>
        const mario = document.getElementById('mario');
        const world = document.getElementById('world');
        const flag = document.getElementById('flag');
        const winScreen = document.getElementById('win-screen');
        const deathScreen = document.getElementById('death-screen');

        const sprites = {
            paradoDir: "./parado_dir.png", paradoEsq: "./parado_esq.png",
            andarDir: "./andar_dir_passo.png", andarEsq: "./andar_esq_passo.png",
            puloDir: "./pulo_dir.png", puloEsq: "./pulo_esq.png",
            agachoDir: "./agacho_dir.png", agachoEsq: "./agacho_esq.png",
            olharCima: "./olhar_cima.png", morto: "./morto.png"
        };

        let posX, posY, velY, velX, isJump, ultimaDirecao, estaAndando, frameAnimacao, jogoAtivo, estaMorto;
        const keys = {};

        function resetJogo() {
            posX = 100; posY = 60; velY = 0; velX = 0;
            isJump = false; ultimaDirecao = 'direita';
            estaAndando = false; frameAnimacao = 0;
            jogoAtivo = true; estaMorto = false;
            
            winScreen.style.display = "none";
            deathScreen.style.display = "none";
            flag.style.bottom = "310px";
            mario.style.opacity = "1";
            world.style.transform = `translateX(0px)`;
        }

        window.addEventListener('keydown', (e) => keys[e.code] = true);
        window.addEventListener('keyup', (e) => keys[e.code] = false);

        function morrer() {
            if (estaMorto) return;
            estaMorto = true;
            jogoAtivo = false;
            mario.src = sprites.morto;
            velY = -15; // Pulo da morte
            setTimeout(() => { deathScreen.style.display = "block"; }, 2000);
        }

        function update() {
            if (estaMorto) {
                velY += 0.8; posY -= velY;
                mario.style.bottom = posY + 'px';
                requestAnimationFrame(update);
                return;
            }

            if (!jogoAtivo) return;

            let isCrouching = (keys['KeyS'] || keys['ArrowDown']) && !isJump;
            let isLookingUp = (keys['KeyW'] || keys['ArrowUp']) && !isJump && !keys['KeyA'] && !keys['KeyD'];
            estaAndando = false;

            if (!isCrouching && !isLookingUp) {
                if (keys['KeyD'] || keys['ArrowRight']) { 
                    velX = 7; ultimaDirecao = 'direita'; estaAndando = true;
                } else if (keys['KeyA'] || keys['ArrowLeft']) { 
                    velX = -7; ultimaDirecao = 'esquerda'; estaAndando = true;
                } else { velX = 0; }
            } else { velX = 0; }

            // Lógica de Sprites
            let imgFinal;
            if (isJump) {
                imgFinal = (ultimaDirecao === 'direita') ? sprites.puloDir : sprites.puloEsq;
            } else if (isCrouching) {
                imgFinal = (ultimaDirecao === 'direita') ? sprites.agachoDir : sprites.agachoEsq;
            } else if (isLookingUp) {
                imgFinal = sprites.olharCima;
            } else if (estaAndando) {
                frameAnimacao++;
                imgFinal = (frameAnimacao % 20 < 10) ? 
                    ((ultimaDirecao === 'direita') ? sprites.paradoDir : sprites.paradoEsq) : 
                    ((ultimaDirecao === 'direita') ? sprites.andarDir : sprites.andarEsq);
            } else {
                imgFinal = (ultimaDirecao === 'direita') ? sprites.paradoDir : sprites.paradoEsq;
            }

            if (!mario.src.endsWith(imgFinal.replace('./', ''))) mario.src = imgFinal;

            // Pulo (Usa Espaço para não conflitar com olhar para cima)
            if (keys['Space'] && !isJump && !isCrouching) { velY = -16; isJump = true; }

            velY += 0.8; posY -= velY; posX += velX;
            if (posY <= 60) { posY = 60; velY = 0; isJump = false; }
            if (posX < 0) posX = 0;

            // Câmera
            let cameraX = posX - 350;
            if (cameraX < 0) cameraX = 0;
            if (cameraX > 4200) cameraX = 4200;
            world.style.transform = `translateX(${-cameraX}px)`;

            mario.style.left = posX + 'px';
            mario.style.bottom = posY + 'px';

            // Vitória
            if (posX >= 4600) {
                jogoAtivo = false;
                flag.style.bottom = "60px";
                setTimeout(() => { winScreen.style.display = "block"; }, 1000);
            }

            // Teste de queda (Morte)
            if (posY < -100) morrer();

            requestAnimationFrame(update);
        }

        resetJogo();
        update();
    </script>
</body>
</html>
